<?xml version='1.0' standalone='yes'?>

<!DOCTYPE PLUGIN [
<!ENTITY name      "unraid-reports">
<!ENTITY author    "dorgan">
<!ENTITY version   "2018.09.24a">
<!ENTITY launch    "Settings/&name;">
<!ENTITY gitURL    "https://raw.githubusercontent.com/dorgan/&name;/master">
<!ENTITY vnstatURL "https://slackonly.com/pub/packages/14.2-x86_64/network/vnstat">
<!ENTITY pluginURL "$gitURL;/&name;.plg">
<!ENTITY emhttp    "/usr/local/emhttp/plugins/&name;">
]>

<PLUGIN  name="&name;"
         author="&author;"
         version="&version;"
         pluginURL="&pluginURL;"
         launch="&launch;">

    <CHANGES>
    ##&name;
    ###2018.09.24 - Adding icon
    - correcting plg, so that plugin shows up in list of installed icons
    ###2018.09.23 - first release
    - first step to creating reporting plugin
    </CHANGES>

    <!--
    The 'plugin' package file.
    -->
    <FILE Name="/boot/config/plugins/&name;/&name;-&version;.txz">
        <URL>&gitURL;/archive/&name;-&version;.txz</URL>
    </FILE>


    <!--
    The 'plugin' MD5 hash.
    -->
    <FILE Name="/boot/config/plugins/&name;/&name;-&version;.md5">
        <URL>&gitURL;/archive/&name;-&version;.md5</URL>
    </FILE>

    <FILE Name="&emhttp;/icons/&name;.png" Type="base64">
        <INLINE>
        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
        </INLINE>
    </FILE>

    <!--
    vnstat file
    -->

    <FILE Run="/bin/bash">
        <INLINE>
            download_install() {
                local dest="/boot/config/plugins/&name;/${1}"
                local src="&vnstatURL;/${1}"
                local md5=$2
                if [ ! -f "${dest}" ]; then
                    curl --location --silent --fail "${src}" --output "${dest}"
                fi
                file_md5=$(/usr/bin/md5sum ${dest})
                if [ "${file_md5:0:32}" != "${md5:0:32}" ]; then
                    echo "Wrong '${1}' package md5 hash."
                    rm "${dest}"
                    exit 1
                else
                    /sbin/installpkg "$dest"
                fi
            }

            # Install vnstat
            if [ ! -f "usr/bin/vnstat" ]; then
                download_install vnstat-1.18-x86_64-1_slonly.txz e7719e1bdc199653a8804673059ffe61
                chmod +x /etc/rc.d/rc.vnstatd
                sed -i -e 's@Interface "eth0"@Interface "bond0"@g' /etc/vnstat.conf
                /etc/rc.d/rc.vnstatd start
            fi

            # Verify and install plugin package
            sum1=$(/usr/bin/md5sum /boot/config/plugins/&name;/&name;-&version;.txz)
            sum2=$(/usr/bin/cat /boot/config/plugins/&name;/&name;-&version;.md5)
            if [ "${sum1:0:32}" != "${sum2:0:32}" ]; then
                echo "Wrong 'plugin' md5 hash."
                rm /boot/config/plugins/&name;/&name;-&version;.txz
                rm /boot/config/plugins/&name;/&name;-&version;.md5
                exit 1
            else
                upgradepkg --install-new /boot/config/plugins/&name;/&name;-&version;.txz
            fi

            # Setting correct permissions
            chmod -R +x /usr/local/emhttp/plugins/&name;/script/

            # Cleaning old source files
            find /boot/config/plugins/&name;/ -type f -iname "&name;*.txz" ! -iname "*&version;*" -delete
            find /boot/config/plugins/&name;/ -type f -iname "&name;*.md5" ! -iname "*&version;*" -delete

            # Creating some directories
            if [ ! -f "/var/lib/vnstat" ]; then
                mkdir /var/lib/vnstat
                vnstat --create -i br0
                vnstat --create -i bond0
            fi

            echo ""
            echo "-----------------------------------------------------------"
            echo " &name; has been installed."
            echo " This plugin requires vnstat to operate"
            echo " Version: &version;"
            echo "-----------------------------------------------------------"
            echo ""
        </INLINE>
    </FILE>

    <!--
    The 'remove' script.
    -->
    <FILE Run="/bin/bash" Method="remove">
        <INLINE>
            # Remove plugin
            find /var/log/packages -type f -iname "&name;-*" -print0 | xargs -0 removepkg

            # Remove plugin config files
            rm -rf "/boot/config/plugins/&name;"

            # Remove possible leftovers
            rm -rf "/usr/local/emhttp/plugins/&name;"

            echo ""
            echo "-----------------------------------------------------------"
            echo " &name; has been uninstalled."
            echo " Please reboot your server to complete uninstall this plugin."
            echo " Version: &version;"
            echo "-----------------------------------------------------------"
            echo ""

            exit 0
        </INLINE>
    </FILE>

</PLUGIN>
